name: Docker Build Service & API

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string
      tag-prefix-service:
        required: false
        type: string  
        default: "service-"  
      tag-prefix-api:
        required: false
        type: string
        default: "api-"                
      dockerfile-service:
        required: false
        type: string
        default: "./deployments/docker/Service.Dockerfile"    
      dockerfile-api:
        required: false
        type: string  
        default: "./deployments/docker/API.Dockerfile"       
      start-build-from:
        required: false
        type: string  
        default: "0"
      dockerhub_username:
        description: "dockerhub username"
        required: false
        type: string
        default: "tazerr"
      multi_arch:
        description: "Build for both amd64 and arm64 (default: false, amd64 only)"
        required: false
        type: boolean
        default: false
    secrets:
      FT_SSH_KEY:
        required: true
      FT_BITBUCKET_KNOWN_HOSTS:
        required: true 
      FT_ECR_AWS_ACCESS_KEY_ID:
        required: true
      FT_ECR_AWS_SECRET_ACCESS_KEY:
        required: true
      DOCKERHUB_PULL_TOKEN:
        required: true                   

jobs:
  build-service:
    name: ${{ matrix.platform == 'linux/arm64' && 'build-service-arm64' || 'build-service' }}
    strategy:
      matrix:
        include: ${{ fromJSON(inputs.multi_arch && '[{"platform":"linux/amd64","runner":"ubuntu-latest"},{"platform":"linux/arm64","runner":"ubuntu-arm64-latest"}]' || '[{"platform":"linux/amd64","runner":"ubuntu-latest"}]') }}
    runs-on: ${{ matrix.runner }}
    steps:
    - name: Build & Publish
      uses: fasttrack-solutions/ci/.github/actions/build-publish-docker@claude/optimize-ci-actions-Ldzjk
      with:
        image: ${{ inputs.image }}
        tag-prefix: ${{ inputs.tag-prefix-service }}
        dockerfile: ${{ inputs.dockerfile-service }}
        ssh_key: ${{ secrets.FT_SSH_KEY }}
        ssh_known_hosts: ${{ secrets.FT_BITBUCKET_KNOWN_HOSTS }}
        ecr_aws_access_key_id: ${{ secrets.FT_ECR_AWS_ACCESS_KEY_ID }}
        ecr_aws_secret_key: ${{ secrets.FT_ECR_AWS_SECRET_ACCESS_KEY }}
        start-build-from: ${{ inputs.start-build-from }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        dockerhub_username: ${{ inputs.dockerhub_username }}
        dockerhub_pull_token: ${{ secrets.DOCKERHUB_PULL_TOKEN }}
        platform: ${{ matrix.platform }}

  build-api:
    name: ${{ matrix.platform == 'linux/arm64' && 'build-api-arm64' || 'build-api' }}
    strategy:
      matrix:
        include: ${{ fromJSON(inputs.multi_arch && '[{"platform":"linux/amd64","runner":"ubuntu-latest"},{"platform":"linux/arm64","runner":"ubuntu-arm64-latest"}]' || '[{"platform":"linux/amd64","runner":"ubuntu-latest"}]') }}
    runs-on: ${{ matrix.runner }}
    steps:
    - name: Build & Publish
      uses: fasttrack-solutions/ci/.github/actions/build-publish-docker@claude/optimize-ci-actions-Ldzjk
      with:
        image: ${{ inputs.image }}
        tag-prefix: ${{ inputs.tag-prefix-api }}
        dockerfile: ${{ inputs.dockerfile-api }}
        ssh_key: ${{ secrets.FT_SSH_KEY }}
        ssh_known_hosts: ${{ secrets.FT_BITBUCKET_KNOWN_HOSTS }}
        ecr_aws_access_key_id: ${{ secrets.FT_ECR_AWS_ACCESS_KEY_ID }}
        ecr_aws_secret_key: ${{ secrets.FT_ECR_AWS_SECRET_ACCESS_KEY }}
        start-build-from: ${{ inputs.start-build-from }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        dockerhub_username: ${{ inputs.dockerhub_username }}
        dockerhub_pull_token: ${{ secrets.DOCKERHUB_PULL_TOKEN }}
        platform: ${{ matrix.platform }}

  create-service-manifest:
    needs: build-service
    runs-on: ubuntu-latest
    steps:
      - name: Create multi-arch manifest for service
        uses: fasttrack-solutions/ci/.github/actions/create-manifest@claude/optimize-ci-actions-Ldzjk
        with:
          image: ${{ inputs.image }}
          start-build-from: ${{ inputs.start-build-from }}
          ecr_aws_access_key_id: ${{ secrets.FT_ECR_AWS_ACCESS_KEY_ID }}
          ecr_aws_secret_key: ${{ secrets.FT_ECR_AWS_SECRET_ACCESS_KEY }}
          dockerhub_username: ${{ inputs.dockerhub_username }}
          dockerhub_pull_token: ${{ secrets.DOCKERHUB_PULL_TOKEN }}
          tag-prefix: ${{ inputs.tag-prefix-service }}

  create-api-manifest:
    needs: build-api
    runs-on: ubuntu-latest
    steps:
      - name: Create multi-arch manifest for API
        uses: fasttrack-solutions/ci/.github/actions/create-manifest@claude/optimize-ci-actions-Ldzjk
        with:
          image: ${{ inputs.image }}
          start-build-from: ${{ inputs.start-build-from }}
          ecr_aws_access_key_id: ${{ secrets.FT_ECR_AWS_ACCESS_KEY_ID }}
          ecr_aws_secret_key: ${{ secrets.FT_ECR_AWS_SECRET_ACCESS_KEY }}
          dockerhub_username: ${{ inputs.dockerhub_username }}
          dockerhub_pull_token: ${{ secrets.DOCKERHUB_PULL_TOKEN }}
          tag-prefix: ${{ inputs.tag-prefix-api }}        